# Squid HTTP Proxy Configuration for Atlassian-Only Access
# This proxy allows connections ONLY to Atlassian domains

# Listening port
http_port 3128

# PID file location (must be on writable tmpfs in read-only container)
pid_filename /var/run/squid/squid.pid

# Access Control Lists (ACLs)
# Define what "Atlassian domains" means
acl atlassian_cloud dstdomain .atlassian.net
acl atlassian_cloud dstdomain .jira.com
acl atlassian_cloud dstdomain .jira-dev.com
acl atlassian_cloud dstdomain .atlassian.com

# SSL/TLS ports (CONNECT method)
acl SSL_ports port 443
acl CONNECT method CONNECT

# Safe HTTP methods
acl Safe_ports port 80    # HTTP
acl Safe_ports port 443   # HTTPS

# Block everything except safe ports
http_access deny !Safe_ports

# Block CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow connections from within the Docker network
# (Squid has a built-in 'localhost' ACL so we don't redefine it)
http_access allow localhost

# MAIN RULE: Allow ONLY Atlassian domains
http_access allow atlassian_cloud

# Deny everything else
http_access deny all

# Logging (to container stderr for debugging)
access_log stdio:/dev/stderr squid
cache_log stdio:/dev/stderr

# Disable caching (we're just a filtering proxy)
cache deny all

# Security: Don't reveal Squid version
httpd_suppress_version_string on

# Security: Don't forward X-Forwarded-For (privacy)
forwarded_for delete

# DNS settings
dns_nameservers 1.1.1.1 8.8.8.8

# Connection timeout
connect_timeout 30 seconds
request_timeout 60 seconds

# Deny direct IP access (force DNS resolution for domain checking)
acl numeric_IPs dstdom_regex ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$
http_access deny numeric_IPs
